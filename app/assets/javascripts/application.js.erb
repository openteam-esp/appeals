/* This is a manifest file that'll be compiled into including all the files listed below.
 * Add new JavaScript/Coffee code in separate files in this directory and they'll automatically
 * be included in the compiled file accessible from http://example.com/assets/application.js
 * It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
 * the compiled file.
 *
 *= require jquery
 *= require jquery-ui
 *= require jquery.ui.datepicker-ru
 *= require jquery.iframe.transport
 *= require jquery.fileupload
 *= require jquery_ujs
 */

function init_datepicker() {

  if ($.fn.datepicker) {
    $("input.datepicker").datepicker({
      changeMonth: true,
      changeYear: true,
      showOn: "button",
      buttonText: '',
      buttonImage: "<%= image_path("ui/calendar.png") %>",
      buttonImageOnly: true
    });
  };

};

function uploads_manage() {
  if ($.fn.fileupload) {
    $("#upload_file").fileupload({
      url: "/public/uploads",
      dataType: "html",
      start: function(e) {
        $("#upload_file").attr("disabled","disabled");
        $("#upload_file_link").addClass("ajax_loading");
        $("#upload_file_link a").addClass("disable");
      },
      stop: function(e) {
        $("#upload_file").removeAttr("disabled");
        $("#upload_file_link").removeClass("ajax_loading");
        $("#upload_file_link a").removeClass("disable");
      },
      add: function(e, data) {
        data.submit()
        .success(function (result, textStatus, jqXHR) {
          $("<div id='ajax_result' />").appendTo("body").hide().html(result);
          $("#new_appeal .uploads").html($("#ajax_result .inputs").html());
          $("#ajax_result").remove();
          uploads_manage();
        })
        .error(function (jqXHR, textStatus, errorThrown) {
          alert(errorThrown + "\n\n" + jqXHR.responseText);
        });
      }
    });
  };
  $("form.appeal .uploads .upload .icon_delete")
    .bind("ajax:beforeSend", function(evt, jqXHR, settings) {
      $(this).parent().addClass("ajax_loading");
    })
    .bind("ajax:complete", function(evt, jqXHR, textStatus) {
      $(this).parent().removeClass("ajax_loading");
    })
    .bind("ajax:success", function(evt, result, textStatus, jqXHR) {
      $("<div id='ajax_result' />").appendTo("body").hide().html(result);
      $("#new_appeal .uploads").html($("#ajax_result .inputs").html());
      $("#ajax_result").remove();
      uploads_manage();
    })
    .bind("ajax:error", function(evt, jqXHR, textStatus, errorThrown) {
      alert(errorThrown + "\n\n" + jqXHR.responseText);
    });
};

$(function() {

  init_datepicker();

  uploads_manage();

  $(".focus_first:first").focus();

  $('.disable').live('click', function(){
    return false;
  });

  $('.actions a').click(function(){
    var id = $(this).attr('id');
    $('.formtastic.'+id).toggle('slow');
    return false;
  });

  $('.reply_wrapper')
    .bind('ajax:success', function(evt, data, status, xhr){
      $('.reply_wrapper').html(xhr.responseText);
      $('.close').addClass('disable');
      init_datepicker();
    })
    .bind('ajax:complete', function(evt, xhr, status){
      $('.reply_wrapper').html(xhr.responseText);
      if ($('.reply_wrapper .reply_info:first').attr('can_close') == 'true') {
        $('.close').removeClass('disable') ;
      } else {
        $('.close').addClass('disable');
      };
    });

});

function preload_images(images) {
  $("<div />")
    .addClass("images_preload")
    .appendTo("body")
    .css({
      "position": "absolute",
      "bottom": 0,
      "left": 0,
      "visibility": "hidden",
      "z-index": -9999
    });
  $.each(images, function(index, value) {
    $("<img src='" + value + "' />").appendTo($(".images_preload"));
  });
};

preload_images([
  "<%= image_path("ajax_loading.gif") %>",
  "<%= image_path("ui/calendar.png") %>"
]);
